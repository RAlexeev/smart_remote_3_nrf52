<!-- HTML header for doxygen 1.8.3.1-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.3.1"/>
<title>Smart Remote 3 nRF52 v1.2 : Audio Probe</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="extra_stylesheet_offline.css" rel="stylesheet" type="text/css"/>
<link href="nordic.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0" width="100%" class="blank">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Nordic Semiconductor" src="nordic_small.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">Smart Remote 3 nRF52 v1.2
   </div>
  </td>
 </tr>
 </tbody>
</table>
<script>
var url=window.location.href.split("/").reverse()[1];
var validLinks= ["nrf5","s130","s132","s212","s332"];
var index;
for (index = 0; index < validLinks.length; ++index) {
   if ( url.indexOf(validLinks[index]) !== -1 ) {
      document.getElementById(validLinks[index]).setAttribute('class', 'doclinks docselected');
   };
};
</script>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.3.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li class="current"><a href="index.html"><span>Introduction</span></a></li>
      <li><a href="usergroup0.html"><span>API&#160;Reference</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('audioprobe.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Groups</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Audio Probe </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>Audio Probe is a desktop application which can be used to inspect sound in <a class="el" href="audio.html">Audio subsystem</a> of a Smart Remote device. It is useful for capturing and injecting audio data before it gets compressed and sent via <em>Bluetooth</em>. The example use cases are:</p>
<ul>
<li>Getting uncompressed audio data from the PDM microphone.</li>
</ul>
<ul>
<li>Optimizing audio algorithms running on an nRF device.</li>
</ul>
<ul>
<li>Testing a codec together with processing and compression algorithms running in firmware by injecting sound from a file to be compressed.</li>
</ul>
<p>The tool has the following requirements:</p>
<ul>
<li>J-Link RTT connection for transferring audio data. nRF52 DK has a built-in J-Link OB with 1 MHz speed which should be enough for default audio sampling rate of 16.125 kHz. For higher rates, or for simultaneous inject and tap, external J-Link probes are recommended.</li>
</ul>
<ul>
<li>Interactive <a href="http://infocenter.nordicsemi.com/topic/com.nordic.infocenter.sdk5.v14.2.0/lib_cli.html" target="_blank">Command Line Interface</a> for runtime configuration of channels and probe points on target.</li>
</ul>
<ul>
<li>Minimum 2 kB RAM on a device for buffering the sound.</li>
</ul>
<h1><a class="anchor" id="audioprobe_behavior"></a>
Behavior</h1>
<p>Audio Probe is designed to have minimal impact on the behavior of Smart Remote. It does not trigger a start or a stop of an audio transmission. It acts as a sniffer - when audio is running Audio Probe saves sound buffers in the RTT channel, fetch it to a computer, and save in a wave file. When inject point is chosen, the sound is read from the wave file on the computer and sent to Smart Remote, instead of the default samples from the microphone or the previous processing stage.</p>
<p>Summing up, the tool exhibits two kinds of behavior.</p>
<ul>
<li><b>tap point</b>: get uncompressed audio from a target to the host. This does not disrupt getting compressed audio on BLE.</li>
</ul>
<ul>
<li><b>inject point</b>: send uncompressed audio from the host to a target, discarding samples from the microphone or the previous processing stage. This does not disrupt "normal" audio over BLE either, however the stream from the microphone is replaced by the one from the host.</li>
</ul>
<h1><a class="anchor" id="audioprobe_setup"></a>
Setup</h1>
<p>Follow this procedure to set up Audio Probe with Smart Remote.</p>
<ol type="1">
<li>Compile the firmware with the "Audio Probe" option enabled. By default, 1 tap channel is chosen.<br/>
 <div class="image">
<img src="audioprobe_enable.png" alt="audioprobe_enable.png"/>
<div class="caption">
Enabling Audio Probe in Smart Remote firmware</div></div>
 <br/>
</li>
<li>Compile and flash the firmware.</li>
<li>Make sure that J-Link is connected.</li>
<li>You can run Audio Probe from the desktop icon or from the Linux terminal using the <code>audioprobe</code> command. The program connects to Smart Remote and provides you with log messages from the firmware. To navigate up and down in the terminal window, use <code>Shift + PageUp</code> and <code>Shift + PageDown</code>.<br/>
 <div class="image">
<img src="audioprobe_console_window.png" alt="audioprobe_console_window.png"/>
<div class="caption">
Audio Probe connected to Smart Remote over RTT</div></div>
 <br/>
</li>
<li>To check which audio probe channels are enabled in the Smart Remote firmware, you can open <b>RTT channels info</b> from the menu <b>RTT</b> (shortcut <code>Ctrl+E</code>). By default, RTT is also used by the logger and CLI (channel 0) and may be used by J-Link tools (channel 1). <br/>
 <div class="image">
<img src="audioprobe_rtt_channel_info.png" alt="audioprobe_rtt_channel_info.png"/>
<div class="caption">
RTT channels enabled in the firmware</div></div>
 <br/>
</li>
<li>To use the Smart Remote audio subsystem, it is required to <a href="http://infocenter.nordicsemi.com/topic/com.nordic.infocenter.rds/dita/rds/designs/smart_remote/smart_remote_3_nrf52/quick_start/pair_w_ubuntu.html" target="_blank">pair the device</a> with the host. Any host that supports audio streaming from Smart Remote (using, for example, NVS or ATVV) can be used. Next, check if the <a href="http://infocenter.nordicsemi.com/topic/com.nordic.infocenter.rds/dita/rds/designs/smart_remote/smart_remote_3_nrf52/quick_start/config_audio.html" target="_blank">audio input is properly configured</a>.</li>
</ol>
<h1><a class="anchor" id="audioprobe_tap"></a>
Tapping audio</h1>
<p>To tap audio from the Smart Remote audio subsystem, go to menu <b>Audio Chain</b> and open the <b>Audio Chain Pipes</b> window (shortcut <code>Ctrl+A</code>). From this window, connect the output audio channel to a chosen tap point.</p>
<div class="image">
<img src="audioprobe_tap_channel.png" alt="audioprobe_tap_channel.png"/>
<div class="caption">
Window for choosing probe points</div></div>
<p> Changing a probe point generates and sends a CLI command in form <code>audio probe &lt;point&gt; &lt;channel&gt;</code>. You can check the active probe points using the <code>audio probe info</code> command, which can be issued automatically by pressing <code>Ctrl+S</code>.</p>
<div class="image">
<img src="audioprobe_command_info.png" alt="audioprobe_command_info.png"/>
<div class="caption">
Audio Probe CLI commands</div></div>
<p> Now, with probe point connected, activate audio streaming in Smart Remote. This can be triggered by any paired host.</p>
<p>On the Ubuntu NVS host, audio stream can be started in one of at least three ways:</p>
<ul>
<li>Go to Ubuntu <b>System Settings</b>, choose <b>Sound</b> and then <b>Input</b> tab, as shown <a href="http://infocenter.nordicsemi.com/topic/com.nordic.infocenter.rds/dita/rds/designs/smart_remote/smart_remote_3_nrf52/quick_start/config_audio.html" target="_blank">here</a>. Double-click <b>NVS device source hidraw</b>, to start the audio transmission.</li>
</ul>
<ul>
<li>Record sound from an NVS input device. For default audio parameters of Smart Remote, this can be done using the following command: <pre class="fragment">parec -v --device=nvs.hidraw1 --rate=16125 --channels=1 --file-format=wav record.wav
</pre></li>
</ul>
<ul>
<li><a href="http://infocenter.nordicsemi.com/topic/com.nordic.infocenter.rds/dita/rds/designs/smart_remote/smart_remote_3_nrf52/quick_start/test_voice_rec.html" target="_blank">Perform voice search</a> with Google Chrome.</li>
</ul>
<p>During an audio transmission, Audio Probe saves data from the chosen probe point and saves it to a file. By default, output files can be found in the user home directory, under <b>audioprobe_data</b>.</p>
<div class="image">
<img src="audioprobe_data.png" alt="audioprobe_data.png"/>
<div class="caption">
Default location of recorded audio and logging data</div></div>
<p> If you have changed the sound parameters in the Smart Remote firmware, you must adjust parameters of the recorded audio. The sound settings window can be found in menu <b>Audio Chain</b> under <b>Sound settings</b> (shortcut <code>Ctrl+G</code>). You should adjust these settings if you have altered the following parameters:</p>
<ul>
<li>sampling rate,</li>
<li>channels number (mono, stereo etc.). Note that with ANR algorithm enabled, if you tap audio from the <b>pdm.out</b> probe point or inject audio to the <b>anr.in</b> point, you should choose 2 channels. Otherwise, use 1 channel.</li>
</ul>
<p>You can examine the audio subsystem configuration using the <code>audio info</code> command. See <a class="el" href="audio.html#audio_cli">Audio CLI commands</a>.</p>
<div class="image">
<img src="audioprobe_sound_settings.png" alt="audioprobe_sound_settings.png"/>
<div class="caption">
Sound settings of the recorded sound</div></div>
 <h1><a class="anchor" id="audioprobe_inject"></a>
Injecting audio</h1>
<p>To enable injection of audio, edit the configuration file and increase the number of down channels to 1 (see <a class="el" href="group__sr3__config__nrf52832__pca63519.html#gaf7fb5577eb8686cced19c69d08b3bee4">CONFIG_AUDIO_PROBE_RTT_CHANNELS_DOWN</a>). You will likely run out of RAM memory for firmware. The easiest solution is to change the codec from Opus to SBC or ADPCM, which require much less memory to operate. You can also disable other Smart Remote features.</p>
<p>After compilation, flash the firmware.</p>
<p>Make sure that Smart Remote is paired with a host. If you changed the audio codec, re-pairing is needed.</p>
<p>To inject audio to Smart Remote, go to menu <b>Audio Chain</b> and open the <b>Audio Chain Pipes</b> window (shortcut <code>Ctrl+A</code>). In this window, select the input file in <b>WAV</b> format and connect the input audio channel to the chosen inject point.</p>
<div class="image">
<img src="audioprobe_choose_input_file.png" alt="audioprobe_choose_input_file.png"/>
<div class="caption">
Choose input file for audio injection</div></div>
 <dl class="section note"><dt>Note</dt><dd>Your input audio file must match the sound parameters of Smart Remote (by default, 16.125 kHz mono with 16-bit sample).</dd></dl>
<p>You can check the active inject points with <code>Ctrl+S</code>. Next, start audio streaming, as described in section <a class="el" href="audioprobe.html#audioprobe_tap">Tapping audio</a>.</p>
<div class="image">
<img src="audioprobe_inject.png" alt="audioprobe_inject.png"/>
<div class="caption">
Successful sound injection: streamed audio after having connected to a probe point</div></div>
<p> The injected sound is expected to be observed instead of microphone samples, for example when using <a href="http://infocenter.nordicsemi.com/topic/com.nordic.infocenter.rds/dita/rds/designs/smart_remote/smart_remote_3_nrf52/quick_start/test_voice_rec.html" target="_blank">Google voice search</a>.</p>
<h1><a class="anchor" id="audioprobe_memory"></a>
Memory usage</h1>
<p>In the configuration file, it is possible to choose the size of the queue of audio buffers to be kept in RTT audio channel for audio tapping and audio injecting. However, keep in mind that audio buffer size depends on the chosen codec, frame size, and bit rate. To get information about these parameters, use command <code>audio info</code>.</p>
<p>You will see information about the number of samples in a frame. With a 16-bit sample, the size of uncompressed audio frame in bytes is twice as big as the number of samples. The final size of the RTT audio channel is visible in menu <b>RTT</b> under <b>RTT channels info</b>. The size of the tap channel is the size of the audio buffer in bytes multiplied by <a class="el" href="group__sr3__config__nrf52832__pca63519.html#ga160f91c2df84c4663a0b52b6b9bd7f88">CONFIG_AUDIO_PROBE_RTT_TAP_BUFFERS</a>. The size of inject channel is the size of the audio buffer in bytes multiplied by <a class="el" href="group__sr3__config__nrf52832__pca63519.html#ga887f9dac8ccffee87686594ea3f67fb4">CONFIG_AUDIO_PROBE_RTT_INJECT_BUFFERS</a>.</p>
<p>If the buffer size is too small, some audio data is lost. The exact behavior depends on RTT setting <code>SEGGER_RTT_CONFIG_DEFAULT_MODE</code>, which can be found in <code>sdk_config.h</code>. There are three modes available for RTT where the buffer does not have space for all data: SKIP (do not block, discard data), TRIM (do not block, put as much data as fits into the buffer), and BLOCK (wait until there is space in the buffer). The default is SKIP. For an isochronous audio stream, regardless of the mode used, if the buffer is too small, you will observe discontinuities in the recorded/injected sound.</p>
<p>The Smart Remote firmware issues a warning if there is not enough space in the RTT buffer for audio tap, or if there is no data in the inject buffer.</p>
<ul>
<li>Warning displayed when the RTT up buffer for audio tapping is too small: <div class="fragment"><div class="line">&lt;warning&gt; m_audio-probe: Tapped an incomplete audio buffer. Recorded sound may be corrupted.</div>
</div><!-- fragment --> <br/>
</li>
<li>Warning displayed when the RTT down buffer for audio injection is too small: <div class="fragment"><div class="line">&lt;warning&gt; m_audio-probe: Injected audio buffer incomplete. Discarding injected data.</div>
</div><!-- fragment --> </li>
</ul>
</div></div><!-- contents -->
</div><!-- doc-content -->
<div id="nav-path" class="topicfooter">
<a href="mailto:docfeedback@nordicsemi.no?subject=Documentation%20feedback" id="maillink">Documentation feedback</a> | <a href="https://devzone.nordicsemi.com/questions/" target="_blank">Developer Zone</a> | <a href="http://response.nordicsemi.com/subscribe-to-our-newsletters" target="_blank">Subscribe</a> | Updated <span id="date"/>
<script>
var date = new Date("Thu Jun 7 2018" + " UTC");
document.getElementById("date").innerHTML = date.toJSON().slice(0, 10);
var url=window.location.href.split("?")[0];
var filename=url.substring(url.lastIndexOf('/')+1);
document.getElementById("maillink").href = "mailto:docfeedback@nordicsemi.no?subject=Documentation%20feedback"+decodeURIComponent("%26")+"body=File%20name%3A%20"+encodeURIComponent(filename);
</script>
</div>
</body>
</html>
