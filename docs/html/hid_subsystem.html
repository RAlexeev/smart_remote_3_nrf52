<!-- HTML header for doxygen 1.8.3.1-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.3.1"/>
<title>Smart Remote 3 nRF52 v1.2 : HID state subsystem</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="extra_stylesheet_offline.css" rel="stylesheet" type="text/css"/>
<link href="nordic.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0" width="100%" class="blank">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Nordic Semiconductor" src="nordic_small.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">Smart Remote 3 nRF52 v1.2
   </div>
  </td>
 </tr>
 </tbody>
</table>
<script>
var url=window.location.href.split("/").reverse()[1];
var validLinks= ["nrf5","s130","s132","s212","s332"];
var index;
for (index = 0; index < validLinks.length; ++index) {
   if ( url.indexOf(validLinks[index]) !== -1 ) {
      document.getElementById(validLinks[index]).setAttribute('class', 'doclinks docselected');
   };
};
</script>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.3.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li class="current"><a href="index.html"><span>Introduction</span></a></li>
      <li><a href="usergroup0.html"><span>API&#160;Reference</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('hid_subsystem.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Groups</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">HID state subsystem </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>The primary function of Smart Remote is to reliably collect the information about user input and transmit it to the host. The main difficulty arises from the fact that due to a limited power budget, the device spends most of its time in low power mode, in which it is not connected to the host. When the user presses a button, the device must wake up, connect to the host, and transmit the information about the button press up the link.</p>
<p>HID state subsystem is responsible for tracking the device connection state and properly routing input events, either to the BLE communication subsystem or to the event queue.</p>
<p>HID events can be divided into two main categories:</p>
<ul>
<li>absolute value events (such as buttons),</li>
<li>relative value events (such as pointer movement coordinates).</li>
</ul>
<p>Depending on the category, HID state subsystem treats events differently. The matrix below presents this behavior.</p>
<table class="doxtable">
<tr>
<th align="center">Input Event Category \ BLE Connection State </th><th align="center">Disconnected </th><th align="center">Connected </th></tr>
<tr>
<td align="center">Absolute </td><td align="center">enqueue </td><td align="center">if (queue_is_not_empty)<br/>
enqueue<br/>
else<br/>
trasmit </td></tr>
<tr>
<td align="center">Relative </td><td align="center">drop </td><td align="center">transmit </td></tr>
</table>
<h1><a class="anchor" id="hid_event_queue"></a>
HID event queue</h1>
<p>When the device is disconnected and an incoming input event cannot be dropped, the event is passed to the HID event queue. The number of the elements in the queue is limited by <a class="el" href="group__sr3__config__nrf52832__pca63519.html#gab6be347561e7dc2d37f964f3b75b34aa">CONFIG_PROTOCOL_HID_EVENT_QUEUE_SIZE</a>. The events are automatically discarded after <a class="el" href="group__sr3__config__nrf52832__pca63519.html#ga4483035a9e7bc6f7c6cf939a63954e7b">CONFIG_HID_REPORT_EXPIRATION</a> milliseconds. When this happens, the following warning message is logged (where %u is substituted with the number of events that were discarded).</p>
<div class="fragment"><div class="line">&lt;warning&gt; m_protocol_hid_state: m_protocol_hid_state_eventq_cleanup(): WARNING: %u stale events removed from the queue! </div>
</div><!-- fragment --><p>It is important that the order in which events are enqueued is maintained. For this reason, an expired event cannot be discarded if any of the events prior to it is not discarded as well. To maintain state sanity, a button down event can only be discarded when a matching button up event is discarded as well. If there is no place in the queue to store an incoming event, the HID state subsystem tries to discard the oldest event in the queue.</p>
<p>The above rules are matched in a general case when keys are pressed and released in a sequence one after another. In this case, the oldest key press and release is discarded, and a new event is stored. When no events are generated and no connection is established, events are discarded after the expiration time defined above. However, if the user presses and holds the button, while simultaneously generating a sequence of other button events, the queue cannot discard events and an overflow happens. To maintain state sanity, all events are dropped in such case. The following warning message is logged.</p>
<div class="fragment"><div class="line">&lt;warning&gt; m_protocol_hid_state: m_protocol_hid_state_enqueue(): WARNING: Queue is full, all events are dropped! </div>
</div><!-- fragment --><h1><a class="anchor" id="hid_event_item"></a>
HID event items</h1>
<p>When the device is connected, all incoming events are scheduled for transmission. This is done through an update of an entry in the event item list and notification sent to the BLE communication subsystem. When the BLE communication subsystem is ready for HID events transmission, it obtains the information about elements present on the event item list, and for each element it constructs a proper entry in the HID report. Elements on the list are present as long as there is any information that causes the report entry to be generated (for example, a button is pressed or mouse position coordinates are updated). When the value associated with the event drops to zero (which means, the button is released or there is no mouse movement), the item is discarded from the list.</p>
<dl class="section note"><dt>Note</dt><dd>Just after the connection is established, all elements present in the event queue are sequentially transmitted to the host. If, during that time, a new input event is generated (and it is an absolute value event), it is enqueued to maintain the correct sequence of input events. In case there is no space in the queue and no event can be discarded, the queue is dropped and event item list is cleared. This action is performed to ensure sanity of the HID state.</dd></dl>
<p>The number of items that are recorded by HID state subsystem is configured with <a class="el" href="group__sr3__config__nrf52832__pca63519.html#gac2c3be8b68f5d1350d64e075086f1ef6">CONFIG_PROTOCOL_HID_STATE_ITEM_COUNT</a>. In case input modules generate more active events at the same time (for example, the keyboard module issues information about more keys being pressed than there are available elements in the list), the incoming event is discarded and the following message is logged.</p>
<div class="fragment"><div class="line">&lt;warning&gt; m_protocol_hid_state: m_protocol_hid_state_set_value(): WARNING: no place on the list to store HID item! </div>
</div><!-- fragment --> </div></div><!-- contents -->
</div><!-- doc-content -->
<div id="nav-path" class="topicfooter">
<a href="mailto:docfeedback@nordicsemi.no?subject=Documentation%20feedback" id="maillink">Documentation feedback</a> | <a href="https://devzone.nordicsemi.com/questions/" target="_blank">Developer Zone</a> | <a href="http://response.nordicsemi.com/subscribe-to-our-newsletters" target="_blank">Subscribe</a> | Updated <span id="date"/>
<script>
var date = new Date("Thu Jun 7 2018" + " UTC");
document.getElementById("date").innerHTML = date.toJSON().slice(0, 10);
var url=window.location.href.split("?")[0];
var filename=url.substring(url.lastIndexOf('/')+1);
document.getElementById("maillink").href = "mailto:docfeedback@nordicsemi.no?subject=Documentation%20feedback"+decodeURIComponent("%26")+"body=File%20name%3A%20"+encodeURIComponent(filename);
</script>
</div>
</body>
</html>
