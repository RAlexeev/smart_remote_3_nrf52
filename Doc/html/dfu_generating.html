<!-- HTML header for doxygen 1.8.3.1-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.3.1"/>
<title>Smart Remote 3 nRF52 v1.2 : Generating custom firmware packages for DFU</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="extra_stylesheet_offline.css" rel="stylesheet" type="text/css"/>
<link href="nordic.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0" width="100%" class="blank">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Nordic Semiconductor" src="nordic_small.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">Smart Remote 3 nRF52 v1.2
   </div>
  </td>
 </tr>
 </tbody>
</table>
<script>
var url=window.location.href.split("/").reverse()[1];
var validLinks= ["nrf5","s130","s132","s212","s332"];
var index;
for (index = 0; index < validLinks.length; ++index) {
   if ( url.indexOf(validLinks[index]) !== -1 ) {
      document.getElementById(validLinks[index]).setAttribute('class', 'doclinks docselected');
   };
};
</script>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.3.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li class="current"><a href="index.html"><span>Introduction</span></a></li>
      <li><a href="usergroup0.html"><span>API&#160;Reference</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('dfu_generating.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Groups</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Generating custom firmware packages for DFU </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>This section provides information about preparing firmware packages used for the OTA-DFU process. When preparing firmware packages, you must install <a href="https://github.com/NordicSemiconductor/pc-nrfutil" target="blank">nrfutil</a>.</p>
<h1><a class="anchor" id="dfu_custom_key"></a>
Public key</h1>
<p>Smart Remote uses cryptographic keys to sign and validate a firmware package used during a DFU procedure. The public key is located in <code>Source\Configuration\bootloader_key.c</code> and it must match the private key that is used during the generation of a firmware package.</p>
<dl class="section warning"><dt>Warning</dt><dd>The private key is not provided. A new key pair must be generated by the user prior to the generation of DFU packages.</dd></dl>
<p><br/>
 </p>
<dl class="section warning"><dt>Warning</dt><dd>When preparing a custom firmware for your device, make sure to generate your own key pair and replace the public key stored in the above-mentioned file.</dd></dl>
<p><br/>
 </p>
<dl class="section warning"><dt>Warning</dt><dd>Remember to safely store the private key as it is needed to generate a valid firmware package for your device. If the private key is lost, you will be unable to update your device with newly generated firmware packages.</dd></dl>
<p>To generate a new private key, run the following command with nrfutil installed. This generates a new key file in the folder where you have run the command. </p>
<div class="fragment"><div class="line">nrfutil keys generate <span class="keyword">private</span>-key.pem</div>
</div><!-- fragment --><p>Replace the existing public key (<code>Source\Configuration\bootloader_key.c</code>) with the new one that is generated from the new private key: </p>
<div class="fragment"><div class="line">nrfutil keys display --format code --out_file <span class="stringliteral">&quot;Source\Configuration\bootloader_key.c&quot;</span> --key pk <span class="keyword">private</span>-key.pem</div>
</div><!-- fragment --><p>To allow evaluation of the DFU process, precompiled firmware images and matching DFU packages are provided in the installation package.</p>
<h1><a class="anchor" id="dfu_custom_bootloader"></a>
Preparing the bootloader</h1>
<p>In Smart Remote, the OTA-DFU process is performed by the bootloader. The bootloader must be present on the device and the application must boot through it.</p>
<p>To generate a new bootloader, compile the <code>SR3_Bootloader</code> project. Use the project and target that matches your SoC version and board. Flash the compiled bootloader onto the board. When the bootloader is flashed to memory, the UICR register is also modified with the address of where the bootloader resides. This address is part of the generated HEX file.</p>
<dl class="section note"><dt>Note</dt><dd>When the location of the bootloader changes (after memory layout modification), make sure to correctly clear the UICR register prior to executing the bootloader flashing procedure to assure that the bootloader address is correctly updated.</dd></dl>
<h1><a class="anchor" id="dfu_generate_package"></a>
OTA-DFU package</h1>
<p>To prepare a firmware package used for the OTA-DFU procedure, use the <code>nrfutil pkg generate</code> command. The tool can prepare a package containing one or more firmware components. For more information, refer to <a href="http://infocenter.nordicsemi.com/topic/com.nordic.infocenter.tools/dita/tools/nrfutil/nrfutil_pkg.html" target="blank">nrfutil documentation</a>. <br/>
 Example: </p>
<div class="fragment"><div class="line">nrfutil pkg generate --application Projects\Firmware_nRF52832\arm5_no_packs\_build\PCA63519-SR3_nRF52832_Shield.hex --application-version 0 --hw-version 0x63519 --sd-req 0xA5 --key-file <span class="keyword">private</span>-key.pem dfu-app.zip</div>
</div><!-- fragment --> <div class="fragment"><div class="line">nrfutil pkg generate --application Projects\Firmware_nRF52810\arm5_no_packs\_build\PCA20031-SR3_nRF52810_Product_Example.hex --application-version 0 --hw-version 0x20031 --sd-req 0xA6 --key-file <span class="keyword">private</span>-key.pem dfu-app.zip</div>
</div><!-- fragment --><h2><a class="anchor" id="dfu_version"></a>
Version requirements</h2>
<p>When generating a new firmware package, version of the components and of the hardware are provided. These versions determine whether it will be possible to perform a DFU process. DFU is only possible if:</p>
<ul>
<li>the component version is greater than or equal to the currently stored one,</li>
<li>the HW version is matching the HW version embedded in the bootloader that is performing the DFU process.</li>
</ul>
<p>The provided precompiled firmware has the following version information:</p>
<ul>
<li>Hardware version:<ul>
<li>0x63519 for the Shield</li>
<li>0x20023 for the nRF52832 based Product Example</li>
<li>0x20031 for the nRF52810 based Product Example</li>
</ul>
</li>
<li>Application: 0</li>
<li>Bootloader: 0</li>
<li>Bootloader Settings: 1</li>
</ul>
<dl class="section note"><dt>Note</dt><dd>HW version used by the bootloader during the DFU procedure is defined in the target-specific configuration header (<code>sr3_config_nrf*.h</code>). Refer to <a class="el" href="group__sr3__config__nrf52832__pca63519.html#gaaa33c99b31473f47059b20f80ee64aa5">CONFIG_DFU_HW_VERSION</a>.</dd></dl>
<h1><a class="anchor" id="dfu_assembly"></a>
Manual Firmware Assembly</h1>
<p>A firmware package which supports OTA-DFU and which can be uploaded to your device through a cable connection, for example during manufacturing, must consist of the following four elements:</p>
<ul>
<li>SoftDevice</li>
<li>Bootloader</li>
<li>Bootloader settings</li>
<li>Application</li>
</ul>
<h2><a class="anchor" id="dfu_bootloader_settings"></a>
Bootloader Settings</h2>
<p>Bootloader settings is a special area in the bootloader that contains information about the DFU process, versions of the application and of the bootloader, and the application checksum. You must generate your own bootloader settings file for your custom firmware. See <a href="http://infocenter.nordicsemi.com/topic/com.nordic.infocenter.tools/dita/tools/nrfutil/nrfutil_settings_generate_display.html" target="blank">nrfutil documentation</a> for information on how to generate the bootloader settings file. Refer to <a class="el" href="dfu_generating.html#dfu_version">Version requirements</a> and make sure that you set the correct versions when generating the bootloader settings file.</p>
<dl class="section note"><dt>Note</dt><dd>The bootloader settings file is required only when preparing a package for a cable connection update.</dd></dl>
<h1><a class="anchor" id="dfu_perform_after_gen"></a>
DFU process</h1>
<p>When your custom package is ready, follow the procedure in <a class="el" href="dfu_performing.html">Running a DFU</a>. </p>
</div></div><!-- contents -->
</div><!-- doc-content -->
<div id="nav-path" class="topicfooter">
<a href="mailto:docfeedback@nordicsemi.no?subject=Documentation%20feedback" id="maillink">Documentation feedback</a> | <a href="https://devzone.nordicsemi.com/questions/" target="_blank">Developer Zone</a> | <a href="http://response.nordicsemi.com/subscribe-to-our-newsletters" target="_blank">Subscribe</a> | Updated <span id="date"/>
<script>
var date = new Date("Thu Jun 7 2018" + " UTC");
document.getElementById("date").innerHTML = date.toJSON().slice(0, 10);
var url=window.location.href.split("?")[0];
var filename=url.substring(url.lastIndexOf('/')+1);
document.getElementById("maillink").href = "mailto:docfeedback@nordicsemi.no?subject=Documentation%20feedback"+decodeURIComponent("%26")+"body=File%20name%3A%20"+encodeURIComponent(filename);
</script>
</div>
</body>
</html>
